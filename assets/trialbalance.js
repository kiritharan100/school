$.widget("custom.searchaccount",$.ui.autocomplete,{_create:function(){this._super();this.widget().menu("option","items","> :not(.ui-autocomplete-category)")},_renderMenu:function(n,t){var r=this,i="";$.each(t,function(t,u){u.Type!=i&&(n.append("<li class='ui-autocomplete-category' title='"+u.Type+"'>"+(u.Type.length>56?u.Type.substr(0,56)+"...":u.Type)+"<\/li>"),i=u.Type);r._renderItem(n,u)})},_renderItem:function(n,t){return $("<li title='"+t.GroupName+"'><\/li>").data("ui-autocomplete-item",t).append("<a>"+(t.Name.length>55?t.Name.substr(0,55)+"...":t.Name)+" <span style='float:right;'>"+t.grp+"<\/span><\/a>").appendTo(n)}});var TB={FocusNextRow:!1,AllAccounts:[],NewItemRow:"",IsUsedInReports:!1,IsEditable:!0,IsImportShowing:!1,IsAutoSaveJournal:!0,IsAutoSaving:!1,AutoSaveInterval:1e4,DeletedItems:[],Init:function(){if(TB.RebindAccountSearch(),TB.IsEditable){$("#txt-from-date").datepicker({format:"dd/mm/yyyy"}).on("show.bs.modal",function(n){n.stopPropagation()});$("#txt-to-date").datepicker({format:"dd/mm/yyyy"}).on("show.bs.modal",function(n){n.stopPropagation()});$("#frm-trialbalance").validate({rules:{DateFrom:{required:!0,date:{format:"dd/mm/yy"}},DateTo:{required:!0,date:{format:"dd/mm/yy"}},VNo:{required:!0}},ignore:":hidden",onkeyup:!1,errorClass:"error",errorElement:"span",submitHandler:function(n,t){var e;t.preventDefault();$("#err-save").html("");var u,r=0,i=0,f=0,v=0,y=0,h=0,c=0,l="",o=!0,s="",a=[],p=$("#txt-from-date").datepicker("getDate"),w=$("#txt-to-date").datepicker("getDate");CompanyType!="Sole Trader"&&w&&p&&(w-p)/864e5>558&&(s="Accounting period can't be more then 18 months.",$("#txt-to-date").focus(),o=!1);$("tr[id^='row-']").each(function(){if(u=this.id.replace("row-",""),f=parseFloat($('[name="Items['+u+'].Id"]').val()),l=$('[name="Items['+u+'].Name"]').val(),r=parseFloat($('[name="Items['+u+'].AmountDr"]').val()),i=parseFloat($('[name="Items['+u+'].AmountCr"]').val()),i||(i=0),r||(r=0),f||(f=0),l||(l=""),i==0&&r==0&&(f<=0||l==""))v++;else{if(r==0&&i==0||f<=0){!f||f<=0?(s="You must select a account for each row",$('[name="Items['+u+'].Name"]').focus()):(!i||i<=0)&&(!r||r<=0)&&(s="You must enter amount for each row",$('[name="Items['+u+'].AmountDr"]').focus());o=!1;return}c+=i;h+=r;a.push({F_AccountMaster:f,Note:$('[name="Items['+u+'].Note"]').val(),Amount:i>0?-1*i:r})}y++});c=Math.round(c*100)/100;h=Math.round(h*100)/100;o&&v==y&&(s="No transaction in the Trial Balance entry.",o=!1);o?TB.IsAutoSaving||($("#btn-save").attr("disabled","disabled"),e={Id:$("#current-record-id").val(),VNo:$("#txt-vno").val(),Name:$("#txt-name").val()},e=TB.IsForJournal()?$.extend(e,{F_AP_TrialBalanceMaster:$("#current-trialbalance-id").val()}):$.extend(e,{F_CompanyPeriods:$("#current-period-id").val(),FromDateStr:$("#txt-from-date").val(),ToDateStr:$("#txt-to-date").val(),ImportType:$("#current-record-type").val(),IsManagement:$("#current-is-management").val()=="1"?!0:!1}),c==h?TB.SaveTrialBalance(e,a):bootbox.confirm((TB.IsForJournal()?"Journal":"Trial Balance")+" is not balanced.<br /><br />Are you sure to save it as unbalanced.",function(n){n?TB.SaveTrialBalance(e,a):$("#btn-save").removeAttr("disabled")})):$("#err-save").html(s)}});$("#tbl-items tbody").on("focus","input[type=text]",function(){$(this).closest("tr").addClass("active")}).on("blur","input[type=text]",function(){$("#tbl-items tbody tr").removeClass("active")});var n=TB.getMaxRowNum()-1;$("[name='Items["+n+"].AmountDr']").bind("blur",function(){TB.autoAddNewRow(this)});$("input[name='Items[1].Name']").focus();TB.SetAutoSave()}else $("#btn-refresh").click(function(){var n=$("#current-record-id").val();return bootbox.confirm("<div id='dynamic-confirm-refresh'>"+$("#div-confirm-refresh").html()+"<\/div>",function(t){if(t){var i=!1;TB.IsUsedInReports&&(i=$("#dynamic-confirm-refresh #chk-refresh-reoprts").is(":checked"));TB.RefreshTrialBalance(n,i)}else $("#btn-refresh").removeAttr("disabled")}),!1});TB.calcTotalAmount()},IsForJournal:function(){return $("#frm-trialbalance input[name=save]").val()=="journal"},SaveTrialBalance:function(n,t){TB.showLoading(!0);CallPageMethod("SaveTrialBalance",function(t){t.d.status?window.location=TB.IsForJournal()?"/accounts/tasks/trialbalance.aspx?id="+n.F_AP_TrialBalanceMaster:"/accounts/tasks/?id="+t.d.id:($("#btn-save").removeAttr("disabled"),TB.showLoading(!1),$("#err-save").html(t.d.message))},function(){$("#btn-save").removeAttr("disabled");TB.showLoading(!1);$("#err-save").html("Error in saving record, please try again.")},{record:n,items:t})},RefreshTrialBalance:function(n,t){TB.showLoading(!0);CallPageMethod("RefreshTrialBalance",function(n){n.d.status?window.location="/accounts/tasks/trialbalance.aspx?id="+n.d.id+"&ret=refresh":$("#err-save").html("");$("#btn-refresh").removeAttr("disabled");TB.showLoading(!1)},function(){$("#btn-refresh").removeAttr("disabled");TB.showLoading(!1)},{Id:n,RefreshReports:t,Name:$("#txt-name").val()})},GetNextYear:function(){var t=Date.fromString($("#txt-from-date").val()),n=new Date(t).addYears(1).addDays(-1),i;n!="Invalid Date"?(i=n.asString("dd/mm/yyyy"),$("#txt-to-date").datepicker("setDate",n),$("#txt-to-date").datepicker("setStartDate",t)):$("#txt-to-date").val("")},RebindAccountSearch:function(){$("input.invAcc").searchaccount({delay:100,source:function(n,t){t(TB.getAccountMatches(n.term))},change:function(){TB.onAccountChange(this)},select:function(n,t){TB.onAccountSelect(this,t.item,n)},close:function(n){var t=TB.getAccountMatches(this.value);if(t&&t.length==1)TB.onAccountSelect(this,t[0],n)}});$("input:text").off("focus").focus(function(){$(this).select()})},getAccountMatches:function(n){return n?$.map(TB.AllAccounts,function(t){if(t.Name&&t.Name.toUpperCase().indexOf(n.toUpperCase())>=0)return $.extend({label:t.Name,desc:t.Code,value:t.Name,id:t.Id},t)}):[]},setAccountDetails:function(n,t){$('[name="Items['+n+'].Name"]').val(t?t.Name:"");$('[name="Items['+n+'].Id"]').val(t?t.Id:"").data("nature",t?t.Nature:"")},onAccountChange:function(n){var r=$(n).val(),t,i;r?(t=$.map(TB.AllAccounts,function(n){if(n.Name&&n.Name.toUpperCase()==r.toUpperCase())return n}),i=n.name.replace("Items[","").replace("].Name",""),t.length==1?TB.setAccountDetails(i,t[0]):t.length==2?TB.setAccountDetails(i,t[1]):TB.setAccountDetails(i,null)):TB.setAccountDetails(i,null)},onAccountSelect:function(n,t,i){var r=n.name.replace("Items[","").replace("].Name","");TB.setAccountDetails(r,t);TB.OnChanged(r);TB.FocusNextRow?$('[name="Items['+(parseInt(r)+1)+'].Name"]').focus():i.keyCode==$.ui.keyCode.TAB?$('[name="Items['+r+'].Note"]').focus():$('[name="Items['+r+'].Note"]').focus();i.preventDefault()},showLoading:function(n){n?($('<img class="dlg-waiting" src="/contents/images/lightbox-ico-loading.gif" style="margin-top: 9px;" />').insertBefore("#div-footer-buttons"),$("#div-footer-buttons").hide()):($(".dlg-waiting").remove(),$("#div-footer-buttons").show())},calcTotalAmount:function(){var t=0,i=0,n=0,u=0,r=0,f="",e=TB.getMaxRowNum()-1;$("[name='Items["+e+"].AmountCr']").bind("blur",function(){TB.autoAddNewRow($(this))});$("tr[id^='row-']").each(function(){var h=$(this),o=$('[name$="AmountDr"]',h),e=$('[name$="AmountCr"]',h),c=$('[name$="Id"]',h).data("nature"),s;f=this.id.replace("row-","");s=/^[-+]?[0-9]+(\.[0-9]+)?$/.test(o.val());s?(o.val(format(o.val(),2)),n=parseFloat(o.val())):(n=0,o.val("0.00"));n||(n=0);n<=0?(s=/^[-+]?[0-9]+(\.[0-9]+)?$/.test(e.val()),s?(e.val(format(e.val(),2)),n=-1*parseFloat(e.val())):(n=0,e.val("0.00")),n||(n=0)):e.val("0.00");n>0?t+=n:i+=n;(c=="Income"||c=="Expenses")&&(r+=-1*n);u++});i=-1*parseFloat(format(i,2));t=parseFloat(format(t,2));$("#invoiceTotalAmountCr").html(currencySymbol+format(i,3));$("#invoiceTotalAmountDr").html(currencySymbol+format(t,3));t==i?$("#invoicestatus").html("Balanced").css("color","green"):t>i?$("#invoicestatus").html("Debit "+format(t-i,2)).css("color","red"):$("#invoicestatus").html("Credit "+format(i-t,2)).css("color","red");r<0?($("#profitLossText").text("Loss"),$("#profitLossAmount").text(currencySymbol+format(-1*r,2))):($("#profitLossText").text("Profit"),$("#profitLossAmount").text(currencySymbol+format(r,2)))},addNewItemRow:function(){var n=$("#tbl-items tbody"),t=TB.getMaxRowNum();return n.append($.validator.format(TB.NewItemRow,t)),TB.RebindAccountSearch(),!1},autoAddNewRow:function(n){var r=!0,t,i;if($("tr[id^='row-']").each(function(){if(rowNum=this.id.replace("row-",""),$("[name$='Name']",this).val()==""){r=!1;return}}),r){TB.addNewItemRow();t=TB.getMaxRowNum()-1;i=$("[name='Items["+t+"].Name']");$("[name='Items["+t+"].AmountDr']").bind("blur",function(){TB.autoAddNewRow(this)});n&&$(n).unbind("blur");try{var u=i.offset().top,f=i.height()+u,e=$(window).height()+$(document).scrollTop()-350;f>e&&$("html, body").animate({scrollTop:u-80},1500)}catch(o){}}},delCurrentRow:function(n){var f="",e=parseInt($("#invoiceRowsCount").val()),i,r,u,t;(isNaN(e)||e!=1)&&(i=!1,$("tr#row-"+n+" input.invAmt").each(function(){$(this).val()!=""&&$(this).val()!="0.00"&&(i=!0)}),i||$("tr#row-"+n+" input.invAcc").each(function(){$(this).val()!=""&&(i=!0)}),r=0,i?(u=$("tr#row-"+n+" input.invAcc").val(),f=u?'Are you sure to delete item "'+u+'"?':"Are you sure to delete item?",confirm(f)&&(t=$("tr#row-"+n),r=t.data("id"),t.remove(),TB.autoAddNewRow())):(t=$("tr#row-"+n),r=t.data("id"),t.remove(),TB.autoAddNewRow()),r>0&&TB.DeletedItems.push(r),TB.calcTotalAmount())},getMaxRowNum:function(){var n=0,t=0;return $("tr[id^='row-']").each(function(){n=parseInt(this.id.replace("row-",""));n>t&&(t=n)}),t+1},OnChanged:function(n){$("tr[id='row-"+n+"']").data("status","");TB.calcTotalAmount()},AutoSave:function(){var n,i;if(TB.IsForJournal()&&!TB.IsAutoSaving&&!TB.IsImportShowing)if(n=$("tr[id^='row-']").not("[data-status='saved']"),n.length>0){TB.IsAutoSaving=!0;var r=$("#current-record-id").val(),u=$("#current-trialbalance-id").val(),f=$("#txt-vno").val(),e=$("#current-record-vnoauto").val(),o=$("#txt-name").val(),t=[];n.each(function(){var n=$(this);n.is(".active")||n.data("status")=="saved"||(rowNum=this.id.replace("row-",""),acc=parseFloat($('[name$="Id"]',n).val()),accName=$('[name$="Name"]',n).val(),amtDr=parseFloat($('[name$="AmountDr"]',n).val()),amtCr=parseFloat($('[name$="AmountCr"]',n).val()),amtCr||(amtCr=0),amtDr||(amtDr=0),acc||(acc=0),accName||(accName=""),amtCr==0&&amtDr==0&&(acc<=0||accName=="")||amtDr==0&&amtCr==0||acc<=0||(t.push({Id:n.data("id")?n.data("id"):0,F_AccountMaster:acc,Note:$('[name$="Note"]',n).val(),Amount:amtCr>0?-1*amtCr:amtDr,Code:rowNum}),$("input",n).attr("disabled","disabled"),$(".btn_delete",n).hide()))});t.length>0?($("#btn-save").data("loading-text","<i class='fa fa-refresh fa-spin'><\/i> Saving...").button("loading"),i=ShowNotification("Saving "+(TB.IsForJournal()?"journal":"trialbalance")+"...","loading",!1),CallPageMethod("SaveJournalAuto",function(n){var t,u;if(n.d.status){if(n.d.SavedItems)for(t in n.d.SavedItems)$("tr[id^='row-"+t+"']").data("status","saved").data("id",n.d.SavedItems[t]);TB.DeletedItems=[];r<=0&&($("#current-record-id").val(n.d.Id),$("#current-trialbalance-id").val(n.d.TBId),u="?tid="+n.d.TBId+"&id="+n.d.Id,window.history.replaceState&&window.history.replaceState(null,null,u))}else ShowNotification("Error in saving records","error");$("tr[id^='row-'] input").removeAttr("disabled");$("tr[id^='row-'] .btn_delete").show();$("#btn-save").button("reset");HideNotification(i);TB.SetAutoSave()},function(){$("#btn-save").button("reset");HideNotification(i);TB.SetAutoSave()},{record:{Id:r,F_AP_TrialBalanceMaster:u,VNo:f,VNoAuto:e,Name:o},items:t,deleted:TB.DeletedItems})):(TB.SetAutoSave(),$("#btn-save").button("reset"))}else TB.SetAutoSave(),$("#btn-save").button("reset")},SetAutoSave:function(){TB.IsAutoSaveJournal&&(TB.IsAutoSaving=!1,setTimeout(function(){TB.AutoSave()},TB.AutoSaveInterval))},ShowImportBalanceDialog:function(){TB.IsImportShowing=!0;$("#err-save").html("");$("#div-import").on("show.bs.modal",function(){$("#cbo-periods option:selected").removeAttr("selected");$("#chk-bfwd-only").removeAttr("checked")}).on("hide.bs.modal",function(){TB.IsImportShowing=!1}).modal()},ImportBalances:function(){if($("#frm-import").valid()){var n=$("#cbo-periods").val(),t=$("#cbo-periods option:selected").text(),i=$("#chk-bfwd-only").is(":checked");$("#div-import").modal("hide");bootbox.confirm("Are you sure to import balances?<br /><br />Note: All entered values will be removed.",function(r){r?CallPageMethod("ImportBalances",function(n){n.d.status?($("#txt-name").val("Balances C/Fwd from "+t),$("#tbl-items tbody tr").remove(),$("#tbl-items tbody").append(n.d.rows),TB.calcTotalAmount(),TB.RebindAccountSearch()):$("#err-save").html("No record returned to be carried forward.")},function(){$("#btn-save").removeAttr("disabled");$("#err-save").html("Error in getting balances, please try again.")},{Id:n,BfwdOnly:i}):TB.IsImportShowing=!1})}},UpdateDesc:function(n){var t=$("#txt-name").val();t==""?Notify("Please Enter Your Description","top-right","5000","danger","fa-bolt",!0):(TB.showLoading(!0),CallPageMethod("Updatedesc",function(n){n.d.status?(window.location.reload(),Notify("Name/Description Updated Successfully.","top-right","5000","success","fa-bolt",!0)):$("#err-save").html("");$("#btn-updesc").removeAttr("disabled");TB.showLoading(!1)},function(){$("#btn-updesc").removeAttr("disabled");TB.showLoading(!1)},{Id:n,Name:$("#txt-name").val()}))}}